#!/bin/ash
# shellcheck shell=dash

# We'll manually edit this file, otherwise any issue in the files used to
# generate the zones file will likely be mirrored here and not be noticed.

if [ "$HEALTHCHECK_BYPASS" = "true" ]; then
  exit 0
fi

redirect_check() {
  if [ -n "$REDIRECT_IPV4" ] && [ "$(dig "$1" @127.0.0.1 A +short)" != "$REDIRECT_IPV4" ]; then
    echo "Failed redirect check IPv4: $1"
    exit 1
  fi
  if [ -n "$REDIRECT_IPV6" ] && [ "$(ip -6 addr)" != "" ] && [ "$(dig "$1" @::1 AAAA +short)" != "$REDIRECT_IPV6" ]; then
    echo "Failed redirect check IPv6: $1"
    exit 1
  fi
}

cname_check() {
  if [ -n "$REDIRECT_IPV4" ] && [ "$(dig "$1" @127.0.0.1 CNAME +short)" != "$2" ]; then
    echo "Failed CNAME check IPv4: $1"
    exit 1
  fi
  if [ -n "$REDIRECT_IPV6" ] && [ "$(ip -6 addr)" != "" ] && [ "$(dig "$1" @::1 CNAME +short)" != "$2" ]; then
    echo "Failed CNAME check IPv6: $1"
    exit 1
  fi
}

block_check() {
  if [ -n "$REDIRECT_IPV4" ] && [ "$(dig "$1" @127.0.0.1 A +short)" != "0.0.0.0" ]; then
    echo "Failed block check IPv4: $1"
    exit 1
  fi
  if [ -n "$REDIRECT_IPV6" ] && [ "$(ip -6 addr)" != "" ] && [ "$(dig "$1" @::1 AAAA +short)" != "::" ]; then
    echo "Failed block check IPv6: $1"
    exit 1
  fi
}

# Redirect Nintendo Landing Page Domains
redirect_check "ctest.cdn.nintendo.net"
redirect_check "conntest.nintendowifi.net"

# Redirect PlayStation Landing Page Domains
redirect_check "www.playstation.com"
redirect_check "manuals.playstation.net"

# Redirect PlayStation Network Test Domains
redirect_check "get.net.playstation.net"
redirect_check "post.net.playstation.net"
redirect_check "ena.net.playstation.net"

# Redirect Generic PlayStation Update Domains
redirect_check "update.net.playstation.net"

# Redirect PS3 Update PUP CDN Domains
redirect_check "djp01.ps3.update.playstation.net"
redirect_check "dus01.ps3.update.playstation.net"
redirect_check "deu01.ps3.update.playstation.net"
redirect_check "dkr01.ps3.update.playstation.net"
redirect_check "duk01.ps3.update.playstation.net"
redirect_check "dmx01.ps3.update.playstation.net"
redirect_check "dau01.ps3.update.playstation.net"
redirect_check "dsa01.ps3.update.playstation.net"
redirect_check "dtw01.ps3.update.playstation.net"
redirect_check "dru01.ps3.update.playstation.net"
redirect_check "dcn01.ps3.update.playstation.net"
redirect_check "dhk01.ps3.update.playstation.net"
redirect_check "dbr01.ps3.update.playstation.net"

# Redirect PS4 Update PUP CDN Domains
redirect_check "djp01.ps4.update.playstation.net"
redirect_check "dus01.ps4.update.playstation.net"
redirect_check "deu01.ps4.update.playstation.net"
redirect_check "dkr01.ps4.update.playstation.net"
redirect_check "duk01.ps4.update.playstation.net"
redirect_check "dmx01.ps4.update.playstation.net"
redirect_check "dau01.ps4.update.playstation.net"
redirect_check "dsa01.ps4.update.playstation.net"
redirect_check "dtw01.ps4.update.playstation.net"
redirect_check "dru01.ps4.update.playstation.net"
redirect_check "dcn01.ps4.update.playstation.net"
redirect_check "dhk01.ps4.update.playstation.net"
redirect_check "dbr01.ps4.update.playstation.net"

# Redirect PS5 Update PUP CDN Domains
redirect_check "djp01.ps5.update.playstation.net"
redirect_check "dus01.ps5.update.playstation.net"
redirect_check "deu01.ps5.update.playstation.net"
redirect_check "dkr01.ps5.update.playstation.net"
redirect_check "duk01.ps5.update.playstation.net"
redirect_check "dmx01.ps5.update.playstation.net"
redirect_check "dau01.ps5.update.playstation.net"
redirect_check "dsa01.ps5.update.playstation.net"
redirect_check "dtw01.ps5.update.playstation.net"
redirect_check "dru01.ps5.update.playstation.net"
redirect_check "dcn01.ps5.update.playstation.net"
redirect_check "dhk01.ps5.update.playstation.net"
redirect_check "dbr01.ps5.update.playstation.net"

# Redirect PS Vita Update PUP CDN Domains
redirect_check "djp01.psp2.update.playstation.net"
redirect_check "dus01.psp2.update.playstation.net"
redirect_check "deu01.psp2.update.playstation.net"
redirect_check "dkr01.psp2.update.playstation.net"
redirect_check "duk01.psp2.update.playstation.net"
redirect_check "dmx01.psp2.update.playstation.net"
redirect_check "dau01.psp2.update.playstation.net"
redirect_check "dsa01.psp2.update.playstation.net"
redirect_check "dtw01.psp2.update.playstation.net"
redirect_check "dru01.psp2.update.playstation.net"
redirect_check "dcn01.psp2.update.playstation.net"
redirect_check "dhk01.psp2.update.playstation.net"
redirect_check "dbr01.psp2.update.playstation.net"

# Redirect PS3 Update List Domains
redirect_check "fjp01.ps3.update.playstation.net"
redirect_check "fus01.ps3.update.playstation.net"
redirect_check "feu01.ps3.update.playstation.net"
redirect_check "fkr01.ps3.update.playstation.net"
redirect_check "fuk01.ps3.update.playstation.net"
redirect_check "fmx01.ps3.update.playstation.net"
redirect_check "fau01.ps3.update.playstation.net"
redirect_check "fsa01.ps3.update.playstation.net"
redirect_check "ftw01.ps3.update.playstation.net"
redirect_check "fru01.ps3.update.playstation.net"
redirect_check "fcn01.ps3.update.playstation.net"
redirect_check "fhk01.ps3.update.playstation.net"
redirect_check "fbr01.ps3.update.playstation.net"

# Redirect PS4 Update List Domains
redirect_check "fjp01.ps4.update.playstation.net"
redirect_check "fus01.ps4.update.playstation.net"
redirect_check "feu01.ps4.update.playstation.net"
redirect_check "fkr01.ps4.update.playstation.net"
redirect_check "fuk01.ps4.update.playstation.net"
redirect_check "fmx01.ps4.update.playstation.net"
redirect_check "fau01.ps4.update.playstation.net"
redirect_check "fsa01.ps4.update.playstation.net"
redirect_check "ftw01.ps4.update.playstation.net"
redirect_check "fru01.ps4.update.playstation.net"
redirect_check "fcn01.ps4.update.playstation.net"
redirect_check "fhk01.ps4.update.playstation.net"
redirect_check "fbr01.ps4.update.playstation.net"

# Redirect PS5 Update List Domains
redirect_check "fjp01.ps5.update.playstation.net"
redirect_check "fus01.ps5.update.playstation.net"
redirect_check "feu01.ps5.update.playstation.net"
redirect_check "fkr01.ps5.update.playstation.net"
redirect_check "fuk01.ps5.update.playstation.net"
redirect_check "fmx01.ps5.update.playstation.net"
redirect_check "fau01.ps5.update.playstation.net"
redirect_check "fsa01.ps5.update.playstation.net"
redirect_check "ftw01.ps5.update.playstation.net"
redirect_check "fru01.ps5.update.playstation.net"
redirect_check "fcn01.ps5.update.playstation.net"
redirect_check "fhk01.ps5.update.playstation.net"
redirect_check "fbr01.ps5.update.playstation.net"

# Redirect PS Vita Update List Domains
redirect_check "fjp01.psp2.update.playstation.net"
redirect_check "fus01.psp2.update.playstation.net"
redirect_check "feu01.psp2.update.playstation.net"
redirect_check "fkr01.psp2.update.playstation.net"
redirect_check "fuk01.psp2.update.playstation.net"
redirect_check "fmx01.psp2.update.playstation.net"
redirect_check "fau01.psp2.update.playstation.net"
redirect_check "fsa01.psp2.update.playstation.net"
redirect_check "ftw01.psp2.update.playstation.net"
redirect_check "fru01.psp2.update.playstation.net"
redirect_check "fcn01.psp2.update.playstation.net"
redirect_check "fhk01.psp2.update.playstation.net"
redirect_check "fbr01.psp2.update.playstation.net"

# Redirect PS4 Update Feature Domains
redirect_check "hjp01.ps4.update.playstation.net"
redirect_check "hus01.ps4.update.playstation.net"
redirect_check "heu01.ps4.update.playstation.net"
redirect_check "hkr01.ps4.update.playstation.net"
redirect_check "huk01.ps4.update.playstation.net"
redirect_check "hmx01.ps4.update.playstation.net"
redirect_check "hau01.ps4.update.playstation.net"
redirect_check "hsa01.ps4.update.playstation.net"
redirect_check "htw01.ps4.update.playstation.net"
redirect_check "hru01.ps4.update.playstation.net"
redirect_check "hcn01.ps4.update.playstation.net"
redirect_check "hhk01.ps4.update.playstation.net"
redirect_check "hbr01.ps4.update.playstation.net"

# Redirect PS5 Update Feature Domains
redirect_check "hjp01.ps5.update.playstation.net"
redirect_check "hus01.ps5.update.playstation.net"
redirect_check "heu01.ps5.update.playstation.net"
redirect_check "hkr01.ps5.update.playstation.net"
redirect_check "huk01.ps5.update.playstation.net"
redirect_check "hmx01.ps5.update.playstation.net"
redirect_check "hau01.ps5.update.playstation.net"
redirect_check "hsa01.ps5.update.playstation.net"
redirect_check "htw01.ps5.update.playstation.net"
redirect_check "hru01.ps5.update.playstation.net"
redirect_check "hcn01.ps5.update.playstation.net"
redirect_check "hhk01.ps5.update.playstation.net"
redirect_check "hbr01.ps5.update.playstation.net"

# Patch PKG Domains
cname_check "b0.ww.np.dl.playstation.net" "sonycoment.vo.llnwd.net"
cname_check "gs.ww.np.dl.playstation.net" "sonycoment.vo.llnwd.net"
cname_check "gs2.ww.np.dl.playstation.net" "sonycoment.vo.llnwd.net"
cname_check "gst.prod.dl.playstation.net" "sonygst.s.llnwi.net"

# Blocked Domains
block_check "nintendo.net"
block_check "nintendowifi.net"
block_check "playstation.com"
block_check "playstation.net"

block_check "wildcard.nintendo.net"
block_check "wildcard.nintendowifi.net"
block_check "wildcard.playstation.com"
block_check "wildcard.playstation.net"

block_check "nintendo-europe.com"
block_check "nintendo.at"
block_check "nintendo.be"
block_check "nintendo.ch"
block_check "nintendo.co.jp"
block_check "nintendo.co.kr"
block_check "nintendo.co.nz"
block_check "nintendo.co.uk"
block_check "nintendo.co.za"
block_check "nintendo.com"
block_check "nintendo.com.au"
block_check "nintendo.com.hk"
block_check "nintendo.cz"
block_check "nintendo.de"
block_check "nintendo.dk"
block_check "nintendo.es"
block_check "nintendo.eu"
block_check "nintendo.fi"
block_check "nintendo.fr"
block_check "nintendo.gr"
block_check "nintendo.hu"
block_check "nintendo.it"
block_check "nintendo.jp"
block_check "nintendo.nl"
block_check "nintendo.no"
block_check "nintendo.pt"
block_check "nintendo.ru"
block_check "nintendo.se"
block_check "nintendo.tw"
block_check "nintendoswitch.cn"
block_check "nintendoswitch.com"
block_check "nintendoswitch.com.cn"
block_check "nintendoservicecentre.co.uk"

block_check "playstation.org"
block_check "scea.com"
block_check "sonyentertainmentnetwork.com"
block_check "sie-rd.com"

block_check "wildcard.nintendo-europe.com"
block_check "wildcard.nintendo.at"
block_check "wildcard.nintendo.be"
block_check "wildcard.nintendo.ch"
block_check "wildcard.nintendo.co.jp"
block_check "wildcard.nintendo.co.kr"
block_check "wildcard.nintendo.co.nz"
block_check "wildcard.nintendo.co.uk"
block_check "wildcard.nintendo.co.za"
block_check "wildcard.nintendo.com"
block_check "wildcard.nintendo.com.au"
block_check "wildcard.nintendo.com.hk"
block_check "wildcard.nintendo.cz"
block_check "wildcard.nintendo.de"
block_check "wildcard.nintendo.dk"
block_check "wildcard.nintendo.es"
block_check "wildcard.nintendo.eu"
block_check "wildcard.nintendo.fi"
block_check "wildcard.nintendo.fr"
block_check "wildcard.nintendo.gr"
block_check "wildcard.nintendo.hu"
block_check "wildcard.nintendo.it"
block_check "wildcard.nintendo.jp"
block_check "wildcard.nintendo.nl"
block_check "wildcard.nintendo.no"
block_check "wildcard.nintendo.pt"
block_check "wildcard.nintendo.ru"
block_check "wildcard.nintendo.se"
block_check "wildcard.nintendo.tw"
block_check "wildcard.nintendoswitch.cn"
block_check "wildcard.nintendoswitch.com"
block_check "wildcard.nintendoswitch.com.cn"
block_check "wildcard.nintendoservicecentre.co.uk"

block_check "wildcard.playstation.org"
block_check "wildcard.scea.com"
block_check "wildcard.sonyentertainmentnetwork.com"
block_check "wildcard.sie-rd.com"

exit 0
