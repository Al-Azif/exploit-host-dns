FROM alpine:3.12

RUN \
    # Update and install system applications
    apk add --update --no-cache \
        bind=9.16.6-r0 \
        python3=3.8.5-r0\
        py3-pip=20.1.1-r0 && \
    pip3 install \
        sre-yield==1.2 \
        watchdog==0.10.4 && \
    # Setup cache directory
    mkdir -p /var/cache/bind && \
    chmod -R 777 /var/cache/bind

# Copy dns-config-watchdog to container
COPY dns-config-watchdog/main.py /opt/dns-config-watchdog/
COPY dns-config-watchdog/zones.json /opt/dns-config-watchdog/

# Copy BIND9 configs to container
COPY bind /etc/bind/

# Copy entrypoint script to container
COPY entrypoint.sh /entrypoint.sh

# Set permissions on copied files
RUN \
    chmod 644 \
        /etc/bind/db.0 \
        /etc/bind/db.127 \
        /etc/bind/db.255 \
        /etc/bind/db.empty \
        /etc/bind/db.local \
        /etc/bind/db.root \
        /etc/bind/named.conf \
        /etc/bind/named.conf.default-zones \
        /etc/bind/named.conf.options.template \
        /etc/bind/zones.rfc1918 && \
    chmod +x /entrypoint.sh

# Expose UDP/TCP port 53
EXPOSE 53/udp 53/tcp

# Start entrypoint script
ENTRYPOINT ["/entrypoint.sh"]

# Set default command for container
CMD ["named", "-c", "/etc/bind/named.conf", "-g", "-u", "named"]
