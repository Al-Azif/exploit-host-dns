FROM alpine:3.18.4

RUN \
    # Update and install system applications
    apk add --update --no-cache \
        bind=9.18.19-r0 \
        bind-tools=9.18.19-r0 \
        libcap=2.69-r0 \
        python3=3.11.6-r0 \
        py3-pip=23.1.2-r0 \
        shadow=4.13-r4 \
        tini=0.19.0-r1 && \
    pip3 install --root-user-action=ignore \
        sre-yield==1.2 \
        watchdog==3.0.0 && \
    # Setup cache directory
    mkdir -p /var/cache/bind && \
    chmod -R 777 /var/cache/bind && \
    # Allow named to use privileged ports without root
    setcap 'cap_net_bind_service=+ep' /usr/sbin/named && \
    # Change named user's uid/gid
    groupmod -g 10001 named && \
    usermod -u 10000 named

# Copy dns-config-watchdog to container
COPY dns-config-watchdog/main.py /opt/dns-config-watchdog/
COPY dns-config-watchdog/zones.json /opt/dns-config-watchdog/

# Copy BIND9 configs to container
COPY bind /etc/bind/

# Copy entrypoint script to container
COPY entrypoint.sh /entrypoint.sh

# Set permissions on copied files
SHELL ["/bin/ash", "-eo", "pipefail", "-c"]
RUN \
    chmod 644 \
        /etc/bind/acl.blockednets \
        /etc/bind/acl.sponsornets \
        /etc/bind/db.0 \
        /etc/bind/db.127 \
        /etc/bind/db.255 \
        /etc/bind/db.empty \
        /etc/bind/db.local \
        /etc/bind/db.root \
        /etc/bind/named.conf \
        /etc/bind/named.conf.default-zones \
        /etc/bind/named.conf.options.template \
        /etc/bind/zones.rfc1918 && \
        crontab -l | { cat; echo "0 0 * * * curl -o \"/etc/bind/db.root\" -z \"/etc/bind/db.root\" \"https://www.internic.net/domain/named.root\" && \$DNS_RESTART"; } | crontab - && \
    chmod +x /entrypoint.sh && \
    chown -R 10000:10001 \
        /etc/bind/ \
        /var/cache/bind/ \
        /var/run/named/ \
        /opt/dns-config-watchdog/

# Expose UDP/TCP port 53
EXPOSE 53/udp 53/tcp

USER named

# Start entrypoint script
ENTRYPOINT ["/sbin/tini", "--", "/entrypoint.sh", "/usr/sbin/named"]

# Set default command for container
CMD ["-g", "-c", "/etc/bind/named.conf"]
